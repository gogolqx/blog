---
layout: post
title: R语言学习与速查（聚类）
category: R
tag: R-learning
---


“聚类分析是一种数据归约技术，旨在揭露一个数据集中观测值的子集。它可以把大量的观测值归约为若干个类。这里的类被定义为若干个观测值组成的群组，群组内观测值的相似度比群间相似度高。”——《R 语言实战》第二版

常用的两种聚类方法有：

1. **层次聚类（hierachical clustering）**：每个数据点为一小类，两两通过树的方式合并，直到所有的数据点汇成一类。常用算法：
   1. **单联动（single linkage）**：
   2. **全联动（complete linkage ）**：
   3. **平均联动（average linkage）**：
   4. **质心（centroid）**：
   5. **Ward 法**：
2. **划分聚类（partitioning clustering）**：事先指定类数 $K$，然后聚类。
   1. **K均值（K-means）**：
   2. **中心划分（Partitioning Around Medoids，即 PAM）**：

## 聚类步骤

聚类是一个多步骤过程。典型的步骤有 11 步。

1. **变量选取**：例如你需要对实验数据进行聚类，那么你需要仔细思考哪些变量会对聚类产生影响，而哪些变量是不需加入分析的。
2. **缩放数据**：最常用的方法是标准化，将所有变量变为 $\overline{x}=0, \mathrm{SE}(x)=1$ 的变量。
3. **筛选异常**：筛选和删除异常数据对于某些聚类方法是很重要的，这可以借助 R 的 `outliers/mvoutlier` 包。或者，你可以换用一种受异常值干扰小的方法，比如中心划分聚类。
4. **距离计算**：两个数据点间的距离度量有若干种，我们在[下一小节]({{ page.url }}#距离计算)专门讨论。
5. **选择聚类方法**：每个方法都有其优缺点，请仔细斟酌。
6. **确定一种或多种聚类方法**
7. **确定类数**：常用的方法是尝试使用不同的类数进行聚类，然后比较结果。R 中的 NbClust 包提供了一个拥有超过30个指标的 NbClust() 函数。
8. **最终方案**
9. **可视化**：层次聚类使用树状图；划分聚类使用可视化双变量聚类图。
10. **解释每个类**：通常会对每个类进行汇总统计（如果是连续型数据），或者返回类的众数/类别分布（如果含类别型数据）。
11. **验证**：聚类结果有意义吗？更换聚类方法能得到类似结果吗？R 中的 fpc, clv 与 clValid 包给出了评估函数。

## 距离计算：dist() 函数

数据点之间的距离有多种度量方法。在 R 的 `dist()` 函数参数中，默认选项 `method=euclidean`。函数中内置的距离方法选项有：

1. **欧几里得距离（euclidean）**：L2 norm. 在拥有 $n$ 个变量的数据集中，数据点 $i$ 与 $j$ 的欧式距离是

  $$ d_{ij} = \sqrt{\sum_{k=1}^{n} (x_{ik} - x_{jk})^2} $$

2. **最大距离（maximun）**：supremum norm. 两点之间的最大距离，应该是通过改变明科夫斯基距离的 p 值来达到最大。

3. **曼哈顿距离（manhattan）**: L1 norm.

  $$ d_{ij} = \sum_{k=1}^{n} |x_{ik}-x_{jk}| $$

4. **堪培拉距离（canberra）**：

  $$ d_{ij} = \sum_{k=1}^{n} (\frac{|x_{ik} - x_{jk}|}{|x_{ik} + x_{jk}|}) $$

5. **二进制距离（binary）**：非 0 变量为 1，为 0 变量为 0.然后根据 0 的比例确定距离。 

6. **明科夫斯基距离（minkowski）**：Lp norm.

  $$ d_{ij} = \sqrt[\uproot{20} p]{\sum_{k=1}^{n} |x_{ik}-x_{jk}|^p } $$
  
  当 $p=1$ 时，即曼哈顿距离；$p=2$ 时，欧几里得距离；$p\to \infty$ 时，切比雪夫距离。

本文利用 [Iris data](https://archive.ics.uci.edu/ml/datasets/Iris)，数据内容是萼片、花瓣的长与宽。先读取数据：


```R
datapath <- paste(getwd(), '/data/iris.data.csv', sep='')  # 我将其改成了 csv 格式
iris.raw <- read.csv(datapath, head=F)

# 去掉非数值的第 5 列
iris <- iris.raw[,-c(5)]
```

### 欧式距离（Euclidean）

R 内置的 `dist()` 函数默认使用欧式距离，以下与 `dist(iris, method='euclidean')` 等同。比如我们来计算 iris 的欧氏距离：


```R
iris.e <- dist(iris)
# 显示前 3 个数据点间的欧式距离。这是一个对角线全0的对称矩阵
as.matrix(iris.e)[1:3, 1:3]
```



| # | 1 | 2 | 3 |
| --- | --- | --- | --- |
| **1** | 0.0000000 | 0.5385165 | 0.509902  |
| **2** | 0.5385165 | 0.0000000 | 0.300000  |
| **3** | 0.5099020 | 0.3000000 | 0.000000  |




*本文内容大量参考《R 语言实战》第二版 第16章*
